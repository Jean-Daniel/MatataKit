#  Matata Devices

Bot and Controller are Bluetooth LE devices with a single Service: `6E400001-B5A3-F393-E0A9-E50E24DCCA9E`
 
 The Service exposes 2 characteristics:
 
 - One `write` /  `writeNoReply` characteristic: `6E400002-B5A3-F393-E0A9-E50E24DCCA9E`
 - One `notify` characteristic: `6E400003-B5A3-F393-E0A9-E50E24DCCA9E`
 
 ## Payload encoding

 Each packet is composed of a 1 byte header with value `254`, followed by the encoded payload.

 Encoded payload are generated by appending a crc16 to the original payload and then encoding the result as follow:

 - replace `253` by the 2 bytes sequence `253` / `221`
 - replace `254` by the 2 bytes equence `253` / `222`

 #### Checksum

 The crc16 checksum is a 2 bytes value computed like this:

 ```swift
 func crc16(_ data: [UInt8]) -> UInt16 {
     var crc: UInt16 = 0xffff;
     for byte in data {
         crc = crc.byteSwapped ^ UInt16(byte);
         crc = crc ^ (crc & 255) >> 4;
         crc = crc ^ (crc << 12);
         crc = crc ^ (crc & 255) << 5;
     }
     return crc;
 }
 ```

 ## Handshake
 
 To control a device, first lookup for a device with the right characteristics.

On dicover -> start listening on the `notify` characteristic.

Once the connection is setup, the device will start broadcasting periodically its identity (null terminated string like `Car:[0x87]\n`) on the notify channel, waiting for an handshake.

The handshake content remains to be defined, but for a controller app llike MatataCode, it is the following payload: `[0x07, 0x7e, 0x2, 0x2, 0x0, 0x0]`

The device should answer a 5 bytes payload like: `[0x06, 0x7e, 0x02, 0x00, 0x00]`

`payload[3] ≠ 0` means that this is a controller that is itself connected to a bot that must be updated.
`payload[4] ≠ 0` means that the device version do not match the extension version and that the device must be updated.

## Controller Status

When connected to a Matata Controller, it can also broadcast periodically information about its configuration.

 - `[0x04, 0x88, 0x00]`: controller in sensor mode.
 - `[0x04, 0x88, 0x07]`: the controller is not in sensor mode.
 - `[0x04, 0x87, 0x02]` : no bot connected ?
